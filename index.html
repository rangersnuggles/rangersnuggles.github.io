<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCGPlayer Price Rounder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 18px;
        }

        .upload-area {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .upload-area.dragover {
            border-color: #007bff;
            background: #e7f3ff;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-upload {
            background: #6c757d;
            color: white;
        }

        .btn-upload:hover {
            background: #5a6268;
        }

        .btn-process {
            background: #007bff;
            color: white;
            margin: 20px auto;
            display: none;
        }

        .btn-process:hover {
            background: #0056b3;
        }

        .btn-download {
            background: #28a745;
            color: white;
        }

        .btn-download:hover {
            background: #218838;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .file-info {
            margin-top: 20px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 6px;
            display: none;
        }

        .stats {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            display: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 10px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .summary {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 25px;
            margin: 30px 0;
            display: none;
        }

        .summary h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-item {
            background: white;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            text-align: center;
        }

        .summary-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .summary-value {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }

        .summary-value.increase {
            color: #28a745;
        }

        .distribution {
            background: white;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .distribution h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .distribution-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .distribution-row:last-child {
            border-bottom: none;
        }

        .message {
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            text-align: center;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .download-section {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 30px;
            display: none;
        }

        .sample-preview {
            margin-top: 30px;
            display: none;
        }

        .sample-preview h3 {
            margin-bottom: 15px;
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 6px;
            overflow: hidden;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .arrow {
            color: #666;
            margin: 0 10px;
        }

        .new-price {
            color: #28a745;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TCGPlayer Price Rounder</h1>
        <p class="subtitle">Round all prices up to the nearest $0.25</p>

        <div class="upload-area" id="uploadArea">
            <input type="file" id="fileInput" accept=".csv">
            <button class="btn btn-upload" onclick="document.getElementById('fileInput').click()">
                Choose CSV File
            </button>
            <p style="color: #666; margin-top: 15px;">or drag and drop a CSV file here</p>
            <div class="file-info" id="fileInfo"></div>
        </div>

        <div class="stats" id="stats">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">File</div>
                    <div class="stat-value" id="fileName" style="font-size: 16px;">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Total Items</div>
                    <div class="stat-value" id="totalItems">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Price Range</div>
                    <div class="stat-value" id="priceRange" style="font-size: 16px;">-</div>
                </div>
            </div>
        </div>

        <div style="text-align: center;">
            <button class="btn btn-process" id="processBtn" onclick="processCSV()">
                Process & Round Prices
            </button>
        </div>

        <div class="message" id="message"></div>

        <div class="summary" id="summary">
            <h3>Processing Summary</h3>
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-label">Total Items</div>
                    <div class="summary-value" id="summaryItems">-</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Original Value</div>
                    <div class="summary-value" id="originalValue">-</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Rounded Value</div>
                    <div class="summary-value" id="roundedValue">-</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Total Increase</div>
                    <div class="summary-value increase" id="totalIncrease">-</div>
                </div>
            </div>
            <div class="distribution">
                <h4>Price Distribution (After Rounding)</h4>
                <div id="priceDistribution"></div>
            </div>
        </div>

        <div class="sample-preview" id="samplePreview">
            <h3>Sample Price Changes</h3>
            <table>
                <thead>
                    <tr>
                        <th>TCGplayer Id</th>
                        <th>Original Price</th>
                        <th>Rounded Price</th>
                    </tr>
                </thead>
                <tbody id="sampleRows"></tbody>
            </table>
        </div>

        <div class="download-section" id="downloadSection">
            <h3 style="margin-bottom: 20px;">Your file is ready!</h3>
            <button class="btn btn-download" onclick="downloadCSV()">
                Download Rounded CSV
            </button>
            <p style="margin-top: 15px; color: #666;" id="downloadFileName"></p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        let currentFile = null;
        let parsedData = null;
        let processedData = null;
        let processedCSV = null;

        // File input handling
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');

        fileInput.addEventListener('change', handleFileSelect);

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.name.endsWith('.csv')) {
                    handleFile(file);
                } else {
                    showMessage('Please upload a CSV file', 'error');
                }
            }
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            currentFile = file;
            
            // Reset UI
            document.getElementById('summary').style.display = 'none';
            document.getElementById('samplePreview').style.display = 'none';
            document.getElementById('downloadSection').style.display = 'none';
            
            // Show file info
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.innerHTML = `<strong>Selected:</strong> ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
            fileInfo.style.display = 'block';

            // Parse CSV
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (!results.meta.fields.includes('TCG Marketplace Price')) {
                        showMessage('Error: CSV must contain "TCG Marketplace Price" column', 'error');
                        return;
                    }
                    
                    parsedData = results;
                    updateStats(file.name, results.data);
                    showMessage('File loaded successfully! Click "Process" to round prices.', 'success');
                    document.getElementById('processBtn').style.display = 'inline-block';
                },
                error: function(error) {
                    showMessage('Error reading file: ' + error.message, 'error');
                }
            });
        }

        function updateStats(fileName, data) {
            const prices = data.map(row => row['TCG Marketplace Price']).filter(p => p !== null && !isNaN(p));
            
            document.getElementById('fileName').textContent = fileName;
            document.getElementById('totalItems').textContent = data.length;
            
            if (prices.length > 0) {
                const min = Math.min(...prices);
                const max = Math.max(...prices);
                document.getElementById('priceRange').textContent = `$${min.toFixed(2)} - $${max.toFixed(2)}`;
            }
            
            document.getElementById('stats').style.display = 'block';
        }

        function roundUpToQuarter(price) {
            return Math.ceil(price * 4) / 4;
        }

        function processCSV() {
            if (!parsedData) {
                showMessage('Please upload a file first', 'error');
                return;
            }

            const btn = document.getElementById('processBtn');
            btn.disabled = true;

            try {
                // Process data
                processedData = parsedData.data.map(row => ({
                    ...row,
                    'TCG Marketplace Price': roundUpToQuarter(row['TCG Marketplace Price'] || 0)
                }));

                // Calculate summary
                let originalTotal = 0;
                let roundedTotal = 0;
                const priceRanges = {
                    '$0.25 - $0.99': 0,
                    '$1.00 - $4.99': 0,
                    '$5.00 - $9.99': 0,
                    '$10.00 - $19.99': 0,
                    '$20.00 - $49.99': 0,
                    '$50.00+': 0
                };

                parsedData.data.forEach((row, index) => {
                    const original = row['TCG Marketplace Price'] || 0;
                    const rounded = processedData[index]['TCG Marketplace Price'];
                    const quantity = row['Add to Quantity'] || 1;
                    
                    originalTotal += original * quantity;
                    roundedTotal += rounded * quantity;
                    
                    // Categorize prices
                    if (rounded >= 0.25 && rounded <= 0.99) priceRanges['$0.25 - $0.99'] += quantity;
                    else if (rounded >= 1 && rounded <= 4.99) priceRanges['$1.00 - $4.99'] += quantity;
                    else if (rounded >= 5 && rounded <= 9.99) priceRanges['$5.00 - $9.99'] += quantity;
                    else if (rounded >= 10 && rounded <= 19.99) priceRanges['$10.00 - $19.99'] += quantity;
                    else if (rounded >= 20 && rounded <= 49.99) priceRanges['$20.00 - $49.99'] += quantity;
                    else if (rounded >= 50) priceRanges['$50.00+'] += quantity;
                });

                // Update summary UI
                document.getElementById('summaryItems').textContent = parsedData.data.length;
                document.getElementById('originalValue').textContent = `$${originalTotal.toFixed(2)}`;
                document.getElementById('roundedValue').textContent = `$${roundedTotal.toFixed(2)}`;
                document.getElementById('totalIncrease').textContent = `+$${(roundedTotal - originalTotal).toFixed(2)}`;

                // Update distribution
                const distHtml = Object.entries(priceRanges)
                    .filter(([_, count]) => count > 0)
                    .map(([range, count]) => `
                        <div class="distribution-row">
                            <span>${range}</span>
                            <span><strong>${count}</strong> items</span>
                        </div>
                    `).join('');
                document.getElementById('priceDistribution').innerHTML = distHtml;

                // Show sample
                showSamplePreview();

                // Convert to CSV
                processedCSV = Papa.unparse(processedData);

                // Show results
                document.getElementById('summary').style.display = 'block';
                document.getElementById('downloadSection').style.display = 'block';
                document.getElementById('downloadFileName').textContent = 
                    `File will be saved as: ${currentFile.name.replace('.csv', '_rounded.csv')}`;

                showMessage('Processing complete! Your rounded prices are ready to download.', 'success');

            } catch (error) {
                showMessage('Error processing file: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
            }
        }

        function showSamplePreview() {
            const tbody = document.getElementById('sampleRows');
            tbody.innerHTML = '';
            
            const samplesToShow = Math.min(5, parsedData.data.length);
            for (let i = 0; i < samplesToShow; i++) {
                const original = parsedData.data[i];
                const processed = processedData[i];
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${original['TCGplayer Id'] || 'N/A'}</td>
                    <td>$${(original['TCG Marketplace Price'] || 0).toFixed(2)}</td>
                    <td>
                        <span class="arrow">→</span>
                        <span class="new-price">$${processed['TCG Marketplace Price'].toFixed(2)}</span>
                    </td>
                `;
                tbody.appendChild(row);
            }
            
            document.getElementById('samplePreview').style.display = 'block';
        }

        function downloadCSV() {
            if (!processedCSV) return;

            const blob = new Blob([processedCSV], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            link.href = url;
            link.download = currentFile.name.replace('.csv', '_rounded.csv');
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            setTimeout(() => URL.revokeObjectURL(url), 100);
            
            showMessage('Download started! Check your downloads folder.', 'success');
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = 'message ' + type;
            msg.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    msg.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>
</html>